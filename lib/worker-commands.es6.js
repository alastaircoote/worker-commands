var storedCommands={},listeners={};function registerCommand(e,t){if(storedCommands[e])throw new Error("Cannot add command '"+e+"', it already exists.");storedCommands[e]=t}function fireIndividualCommand(e,t){var n=e.command,r=e.options;if(!storedCommands[n])throw new Error("No such command '"+n+"'");return listeners[n]&&listeners[n].forEach(function(e){return e(r,t)}),storedCommands[n](r,t)}function fireCommand(e,t){return e instanceof Array?Promise.all(e.map(function(e){return fireIndividualCommand(e,t)})):fireIndividualCommand(e,t)}function addListener(e,t){listeners[e]||(listeners[e]=new Set),listeners[e].add(t)}function removeListener(e,t){listeners[e]&&listeners[e].delete(t)}function __rest(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&(n[r[o]]=e[r[o]])}return n}function __awaiter(e,t,n,r){return new(n||(n=Promise))(function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(a,s)}c((r=r.apply(e,t||[])).next())})}function __generator(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=r[2&i[0]?"return":i[0]?"throw":"next"])&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[0,o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}function showNotification(e){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(o){switch(o.label){case 0:if(!e.title||!e.body)throw new Error("Notification must, at at a minimum, provide title and body.");return t=e.title,n=e.events,(r=__rest(e,["title","events"])).data=Object.assign(r.data||{},{__workerCommandNotification:!0,__events:n}),[4,self.registration.showNotification(t,r)];case 1:return o.sent(),[2]}})})}function removeNotifications(e,t){return __awaiter(this,void 0,void 0,function(){var n;return __generator(this,function(r){switch(r.label){case 0:if(!(n=e?e.tag:void 0)&&t)t.notification.close();else if(!n)throw new Error("Must provide a notificationevent or tag to remove notification");return[4,self.registration.getNotifications({tag:n})];case 1:return r.sent().forEach(function(e){!0===checkIfLibraryNotification(e)&&e.close()}),[2]}})})}function processNotificationClick(e,t){return __awaiter(this,void 0,void 0,function(){var e,n,r;return __generator(this,function(o){switch(o.label){case 0:if(!t)throw new Error("Cannot process notification click without also sending event");return!1===checkIfLibraryNotification(e=t.notification)?[2]:e.data.__events?(n="click",t.action&&(n=t.action),(r=e.data.__events["on"+n])?[4,fireCommand(r,t)]:(console.error("Notification received on"+n+" event, but no listener was attached"),[2])):(console.warn("Notification received a click event but has no events attached."),[2]);case 1:return o.sent(),[2]}})})}function processNotificationClose(e,t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(n){switch(n.label){case 0:if(!t)throw new Error("Cannot process notification click without also sending event");return!1===checkIfLibraryNotification(e=t.notification)?[2]:e.data.__events&&e.data.__events.onclose?[4,fireCommand(e.data.__events.onclose,t)]:(console.info("Notification received a close event with no events attached."),[2]);case 1:return n.sent(),[2]}})})}function checkIfLibraryNotification(e){return e.data&&!0===e.data.__workerCommandNotification}function setup(){registerCommand("notification.show",showNotification),registerCommand("notification.close",removeNotifications),registerCommand("notification.process-click",processNotificationClick),registerCommand("notification.process-close",processNotificationClose),self.addEventListener("notificationclick",function(e){e.waitUntil(fireCommand({command:"notification.process-click"},e))}),self.addEventListener("notificationclose",function(e){e.waitUntil(fireCommand({command:"notification.process-close"},e))})}function filterURL(e,t){var n=new URL(e);return!0===t.ignoreQuery&&(n.search=""),!0===t.ignoreHash&&(n.hash=""),n.href}function getExistingWindow(e,t){return __awaiter(this,void 0,void 0,function(){var n;return __generator(this,function(r){switch(r.label){case 0:return[4,self.clients.matchAll({includeUncontrolled:!0})];case 1:return n=r.sent(),filterURL(e,t),[2,n.find(function(n){return filterURL(n.url,t)===e&&n instanceof WindowClient})]}})})}function focusWindow(e){return __awaiter(this,void 0,void 0,function(){var t,n,r,o;return __generator(this,function(i){switch(i.label){case 0:return e&&e.url?[3,3]:[4,self.clients.matchAll()];case 1:if(t=i.sent(),!(n=t.find(function(e){return e instanceof WindowClient})))throw new Error("Tried to focus, but there were no client windows");return[4,n.focus()];case 2:return i.sent(),[2];case 3:return[4,getExistingWindow(r=new URL(e.url,self.location.href).href,e)];case 4:return(o=i.sent())?[4,o.focus()]:[3,6];case 5:return i.sent(),[3,9];case 6:return!0!==e.openIfNotExisting?[3,8]:[4,self.clients.openWindow(r)];case 7:return i.sent(),[3,9];case 8:console.error("Tried to focus a window that didn't exist! "+r),i.label=9;case 9:return[2]}})})}function openWindow(e){return __awaiter(this,void 0,void 0,function(){var t,n;return __generator(this,function(r){switch(r.label){case 0:return t=new URL(e.url,self.location.href).href,e.focusIfExisting?[3,2]:[4,self.clients.openWindow(e.url)];case 1:return r.sent(),[3,7];case 2:return[4,getExistingWindow(t,e)];case 3:return(n=r.sent())?[4,n.focus()]:[3,5];case 4:return r.sent(),[3,7];case 5:return[4,self.clients.openWindow(e.url)];case 6:r.sent(),r.label=7;case 7:return[2]}})})}function postMessage(e){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(n){switch(n.label){case 0:return[4,self.clients.matchAll()];case 1:return t=n.sent(),e.url&&(t=t.filter(function(t){return t.url===e.url})),t.forEach(function(t){return t.postMessage(e.message)}),[2]}})})}function setup$1(){registerCommand("client.focus",focusWindow),registerCommand("client.open",openWindow),registerCommand("client.post-message",postMessage)}function update(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,self.registration.update()];case 1:return e.sent(),[2]}})})}function unregister(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,self.registration.unregister()];case 1:return e.sent(),[2]}})})}function setup$2(){registerCommand("registration.update",update),registerCommand("registration.unregister",unregister)}function handlePush(e){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(n){switch(n.label){case 0:return e.data?[4,e.data.json()]:[2];case 1:return(t=n.sent()).data&&t.data.payload?(t=JSON.parse(t.data.payload),[3,4]):[3,2];case 2:return t.notification&&t.data&&t.data.__isWorkerCommandPayload?(console.info("Received Firebase notification payload"),[4,fireCommand({command:"notification.show",options:t.notification})]):[3,4];case 3:return n.sent(),[2];case 4:return t.__workerCommandPayload?(console.info("Received push payload",t.__workerCommandPayload),[4,fireCommand(t.__workerCommandPayload)]):[2];case 5:return n.sent(),[2]}})})}function setup$3(){self.addEventListener("push",function(e){e.waitUntil(handlePush(e))})}function cacheAdd(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:if(!e)throw new Error("Options not provided");if(!e.cacheName)throw new Error("Cache name not provided");if(!e.urls)throw new Error("Cache URLs not provided");return[4,caches.open(e.cacheName)];case 1:return[2,t.sent().addAll(e.urls)]}})})}function cacheDelete(e){return __awaiter(this,void 0,void 0,function(){var t,n;return __generator(this,function(r){switch(r.label){case 0:if(!e)throw new Error("Options not provided");if(e.urls&&!0===e.deleteWholeCache)throw new Error("Cannot specify both urls and deleteWholeCache options");if(!e.cacheName)throw new Error("Cache name not provided");if(!0===e.deleteWholeCache)return[2,caches.delete(e.cacheName)];if(!e.urls)throw new Error("Must provide URLs if not using deleteWholeCache");return[4,caches.open(e.cacheName)];case 1:return t=r.sent(),n=e.urls.map(function(e){return t.delete(e)}),[2,Promise.all(n)]}})})}function setup$4(){registerCommand("cache.add",cacheAdd),registerCommand("cache.delete",cacheDelete)}var PAYLOAD_KEY="__workerCommandPayload";function sendClient(e){return window.navigator.serviceWorker.ready.then(function(t){if(!t.active)throw new Error("Received a worker registration but it has no active worker");var n=new MessageChannel,r=new Promise(function(e,t){n.port2.onmessage=function(n){n.data&&n.data instanceof Array||t(new Error("Did not recognise response from worker command call"));var r=n.data,o=r[0],i=r[1];o?t(new Error(o)):e(i)}}),o={};return o[PAYLOAD_KEY]=e,t.active.postMessage(o,[n.port1]),r})}function setup$5(){var e=this;self.addEventListener("message",function(t){return __awaiter(e,void 0,void 0,function(){var e,n,r,o;return __generator(this,function(i){switch(i.label){case 0:if(!(e=t).data||!e.data[PAYLOAD_KEY])return[2];if(!(n=e.ports[0]))throw new Error("Send worker command payload with no reply port");i.label=1;case 1:return i.trys.push([1,3,,4]),[4,fireCommand(e.data[PAYLOAD_KEY])];case 2:return r=i.sent(),n.postMessage([null,r]),[3,4];case 3:return o=i.sent(),n.postMessage([o.message,null]),[3,4];case 4:return[2]}})})})}function setup$6(){setup(),setup$1(),setup$2(),setup$3(),setup$4(),setup$5()}export{setup$6 as setup,fireCommand,registerCommand,addListener,removeListener,sendClient as sendCommand};
//# sourceMappingURL=worker-commands.es6.js.map
