!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(e["worker-commands"]={})}(this,function(e){"use strict";var n={},t={};function r(e,t){if(n[e])throw new Error("Cannot add command '"+e+"', it already exists.");n[e]=t}function o(e,r){var o=e.command,i=e.options;if(!n[o])throw new Error("No such command '"+o+"'");return t[o]&&t[o].forEach(function(e){return e(i,r)}),n[o](i,r)}function i(e,n){return e instanceof Array?Promise.all(e.map(function(e){return o(e,n)})):o(e,n)}function a(e,n,t,r){return new(t||(t=Promise))(function(o,i){function a(e){try{s(r.next(e))}catch(e){i(e)}}function c(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){e.done?o(e.value):new t(function(n){n(e.value)}).then(a,c)}s((r=r.apply(e,n||[])).next())})}function c(e,n){var t,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(t)throw new TypeError("Generator is already executing.");for(;a;)try{if(t=1,r&&(o=r[2&i[0]?"return":i[0]?"throw":"next"])&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[0,o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=n.call(e,a)}catch(e){i=[6,e],r=0}finally{t=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}function s(e){return a(this,void 0,void 0,function(){var n,t,r;return c(this,function(o){switch(o.label){case 0:if(!e.title||!e.body)throw new Error("Notification must, at at a minimum, provide title and body.");return n=e.title,t=e.events,(r=function(e,n){var t={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&n.indexOf(r)<0&&(t[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)n.indexOf(r[o])<0&&(t[r[o]]=e[r[o]])}return t}(e,["title","events"])).data=Object.assign(r.data||{},{__workerCommandNotification:!0,__events:t}),[4,self.registration.showNotification(n,r)];case 1:return o.sent(),[2]}})})}function u(e,n){return a(this,void 0,void 0,function(){var t;return c(this,function(r){switch(r.label){case 0:if(!(t=e?e.tag:void 0)&&n)n.notification.close();else if(!t)throw new Error("Must provide a notificationevent or tag to remove notification");return[4,self.registration.getNotifications({tag:t})];case 1:return r.sent().forEach(function(e){!0===d(e)&&e.close()}),[2]}})})}function f(e,n){return a(this,void 0,void 0,function(){var e,t,r;return c(this,function(o){switch(o.label){case 0:if(!n)throw new Error("Cannot process notification click without also sending event");return!1===d(e=n.notification)?[2]:e.data.__events?(t="click",n.action&&(t=n.action),(r=e.data.__events["on"+t])?[4,i(r,n)]:(console.error("Notification received on"+t+" event, but no listener was attached"),[2])):(console.warn("Notification received a click event but has no events attached."),[2]);case 1:return o.sent(),[2]}})})}function l(e,n){return a(this,void 0,void 0,function(){var e;return c(this,function(t){switch(t.label){case 0:if(!n)throw new Error("Cannot process notification click without also sending event");return!1===d(e=n.notification)?[2]:e.data.__events&&e.data.__events.onclose?[4,i(e.data.__events.onclose,n)]:(console.info("Notification received a close event with no events attached."),[2]);case 1:return t.sent(),[2]}})})}function d(e){return e.data&&!0===e.data.__workerCommandNotification}function h(e,n){var t=new URL(e);return!0===n.ignoreQuery&&(t.search=""),!0===n.ignoreHash&&(t.hash=""),t.href}function w(e,n){return a(this,void 0,void 0,function(){var t;return c(this,function(r){switch(r.label){case 0:return[4,self.clients.matchAll({includeUncontrolled:!0})];case 1:return t=r.sent(),h(e,n),[2,t.find(function(t){return h(t.url,n)===e&&t instanceof WindowClient})]}})})}function v(e){return a(this,void 0,void 0,function(){var n,t,r,o;return c(this,function(i){switch(i.label){case 0:return e&&e.url?[3,3]:[4,self.clients.matchAll()];case 1:if(n=i.sent(),!(t=n.find(function(e){return e instanceof WindowClient})))throw new Error("Tried to focus, but there were no client windows");return[4,t.focus()];case 2:return i.sent(),[2];case 3:return[4,w(r=new URL(e.url,self.location.href).href,e)];case 4:return(o=i.sent())?[4,o.focus()]:[3,6];case 5:return i.sent(),[3,9];case 6:return!0!==e.openIfNotExisting?[3,8]:[4,self.clients.openWindow(r)];case 7:return i.sent(),[3,9];case 8:console.error("Tried to focus a window that didn't exist! "+r),i.label=9;case 9:return[2]}})})}function p(e){return a(this,void 0,void 0,function(){var n,t;return c(this,function(r){switch(r.label){case 0:return n=new URL(e.url,self.location.href).href,e.focusIfExisting?[3,2]:[4,self.clients.openWindow(e.url)];case 1:return r.sent(),[3,7];case 2:return[4,w(n,e)];case 3:return(t=r.sent())?[4,t.focus()]:[3,5];case 4:return r.sent(),[3,7];case 5:return[4,self.clients.openWindow(e.url)];case 6:r.sent(),r.label=7;case 7:return[2]}})})}function m(e){return a(this,void 0,void 0,function(){var n;return c(this,function(t){switch(t.label){case 0:return[4,self.clients.matchAll()];case 1:return n=t.sent(),e.url&&(n=n.filter(function(n){return n.url===e.url})),n.forEach(function(n){return n.postMessage(e.message)}),[2]}})})}function b(){return a(this,void 0,void 0,function(){return c(this,function(e){switch(e.label){case 0:return[4,self.registration.update()];case 1:return e.sent(),[2]}})})}function y(){return a(this,void 0,void 0,function(){return c(this,function(e){switch(e.label){case 0:return[4,self.registration.unregister()];case 1:return e.sent(),[2]}})})}function g(){self.addEventListener("push",function(e){e.waitUntil(function(e){return a(this,void 0,void 0,function(){var n;return c(this,function(t){switch(t.label){case 0:return e.data?[4,e.data.json()]:[2];case 1:return(n=t.sent()).data&&n.data.payload?(n=JSON.parse(n.data.payload),[3,4]):[3,2];case 2:return n.notification&&n.data&&n.data.__isWorkerCommandPayload?(console.info("Received Firebase notification payload"),[4,i({command:"notification.show",options:n.notification})]):[3,4];case 3:return t.sent(),[2];case 4:return n.__workerCommandPayload?(console.info("Received push payload",n.__workerCommandPayload),[4,i(n.__workerCommandPayload)]):[2];case 5:return t.sent(),[2]}})})}(e))})}function E(e){return a(this,void 0,void 0,function(){return c(this,function(n){switch(n.label){case 0:if(!e)throw new Error("Options not provided");if(!e.cacheName)throw new Error("Cache name not provided");if(!e.urls)throw new Error("Cache URLs not provided");return[4,caches.open(e.cacheName)];case 1:return[2,n.sent().addAll(e.urls)]}})})}function _(e){return a(this,void 0,void 0,function(){var n,t;return c(this,function(r){switch(r.label){case 0:if(!e)throw new Error("Options not provided");if(e.urls&&!0===e.deleteWholeCache)throw new Error("Cannot specify both urls and deleteWholeCache options");if(!e.cacheName)throw new Error("Cache name not provided");if(!0===e.deleteWholeCache)return[2,caches.delete(e.cacheName)];if(!e.urls)throw new Error("Must provide URLs if not using deleteWholeCache");return[4,caches.open(e.cacheName)];case 1:return n=r.sent(),t=e.urls.map(function(e){return n.delete(e)}),[2,Promise.all(t)]}})})}var k="__workerCommandPayload";e.setup=function(){r("notification.show",s),r("notification.close",u),r("notification.process-click",f),r("notification.process-close",l),self.addEventListener("notificationclick",function(e){e.waitUntil(i({command:"notification.process-click"},e))}),self.addEventListener("notificationclose",function(e){e.waitUntil(i({command:"notification.process-close"},e))}),r("client.focus",v),r("client.open",p),r("client.post-message",m),r("registration.update",b),r("registration.unregister",y),g(),r("cache.add",E),r("cache.delete",_),function(){var e=this;self.addEventListener("message",function(n){return a(e,void 0,void 0,function(){var e,t,r,o;return c(this,function(a){switch(a.label){case 0:if(!(e=n).data||!e.data[k])return[2];if(!(t=e.ports[0]))throw new Error("Send worker command payload with no reply port");a.label=1;case 1:return a.trys.push([1,3,,4]),[4,i(e.data[k])];case 2:return r=a.sent(),t.postMessage([null,r]),[3,4];case 3:return o=a.sent(),t.postMessage([o.message,null]),[3,4];case 4:return[2]}})})})}()},e.fireCommand=i,e.registerCommand=r,e.addListener=function(e,n){t[e]||(t[e]=new Set),t[e].add(n)},e.removeListener=function(e,n){t[e]&&t[e].delete(n)},e.sendCommand=function(e){return window.navigator.serviceWorker.ready.then(function(n){if(!n.active)throw new Error("Received a worker registration but it has no active worker");var t=new MessageChannel,r=new Promise(function(e,n){t.port2.onmessage=function(t){t.data&&t.data instanceof Array||n(new Error("Did not recognise response from worker command call"));var r=t.data,o=r[0],i=r[1];o?n(new Error(o)):e(i)}}),o={};return o[k]=e,n.active.postMessage(o,[t.port1]),r})},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=worker-commands.js.map
